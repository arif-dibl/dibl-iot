global
    log stdout format raw local0 notice
    tune.ssl.default-dh-param 4096
    fd-hard-limit 1048576

defaults
    log global
    mode http
    timeout connect 30s
    timeout client 60s
    timeout server 60s
    timeout tunnel 720m
    default-server init-addr none

resolvers docker_resolver
    nameserver dns 127.0.0.11

frontend http
    bind *:80

    # Health endpoint for docker healthcheck
    acl url_docker_health path /docker-health
    http-request set-log-level silent if url_docker_health
    http-request return status 200 if url_docker_health

    # Route auth paths to Keycloak
    acl auth path_beg /auth
    use_backend keycloak_backend if auth

    # Route realms paths to Keycloak (for direct realm access)
    acl realms path_beg /realms
    use_backend keycloak_backend if realms

    # Route resources paths to Keycloak (for Keycloak static resources)
    acl resources path_beg /resources
    use_backend keycloak_backend if resources

    # Everything else goes to Manager
    default_backend manager_backend

# MQTT without TLS (internal only, Traefik handles external TLS if needed)
listen mqtt
    bind *:1883
    mode tcp
    option clitcpka
    timeout client 3h
    timeout server 3h
    balance leastconn
    server manager manager:1883 resolvers docker_resolver

backend manager_backend
    server manager manager:8080 resolvers docker_resolver

backend keycloak_backend
    server keycloak keycloak:8080 resolvers docker_resolver
