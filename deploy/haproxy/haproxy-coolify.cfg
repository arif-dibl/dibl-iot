global
    log stdout format raw local0 notice

defaults
    log global
    mode http
    timeout connect 30s
    timeout client 60s
    timeout server 60s
    timeout tunnel 720m
    default-server init-addr none

resolvers docker_resolver
    nameserver dns1 127.0.0.11:53

frontend http
    bind *:80

    # CRITICAL: Forward original protocol and host info from Traefik
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-Port 443
    http-request set-header X-Forwarded-Host %[req.hdr(host)]
    http-request set-header X-Real-IP %[src]

    # Health endpoint for docker healthcheck
    acl url_docker_health path /docker-health
    http-request set-log-level silent if url_docker_health
    http-request return status 200 if url_docker_health

    # Route auth paths to Keycloak
    acl is_auth path_beg /auth
    use_backend keycloak_backend if is_auth

    # Route realms paths to Keycloak
    acl is_realms path_beg /realms
    use_backend keycloak_backend if is_realms

    # Route resources paths to Keycloak
    acl is_resources path_beg /resources
    use_backend keycloak_backend if is_resources

    # Route custom-ui paths
    acl is_customui path_beg /customui
    use_backend customui_backend if is_customui

    # Everything else goes to Manager
    default_backend manager_backend

backend manager_backend
    server manager manager:8080 resolvers docker_resolver init-addr none

backend keycloak_backend
    server keycloak keycloak:8080 resolvers docker_resolver init-addr none

backend customui_backend
    server customui custom-ui:5000 resolvers docker_resolver init-addr none
