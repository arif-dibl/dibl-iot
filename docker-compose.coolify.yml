# OpenRemote v3 - Coolify Production Deployment (Direct Routing)
# Traefik handles all external routing, bypassing OpenRemote's internal proxy
# This avoids SSL conflicts and redirect loops with Coolify

volumes:
  manager-data:
  postgresql-data:


services:
  postgresql:
    restart: always
    image: openremote/postgresql:${POSTGRESQL_VERSION:-latest}
    shm_size: 128mb
    volumes:
      - postgresql-data:/var/lib/postgresql/data
      - manager-data:/storage
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  keycloak:
    restart: always
    image: openremote/keycloak:${KEYCLOAK_VERSION:-latest}
    depends_on:
      postgresql:
        condition: service_healthy
    volumes:
      - ./deploy:/deployment
    environment:
      KEYCLOAK_ADMIN_PASSWORD: ${OR_ADMIN_PASSWORD:?Admin password required}
      KC_HOSTNAME: ${OR_HOSTNAME:?Hostname required}
      KC_HOSTNAME_PORT: ${OR_SSL_PORT:--1}
    labels:
      - "traefik.enable=true"
      # Route /auth and /realms paths to Keycloak (priority 100 = high)
      - "traefik.http.routers.keycloak.priority=100"
      - "traefik.http.routers.keycloak.rule=Host(`${OR_HOSTNAME}`) && PathPrefix(`/auth`)"
      - "traefik.http.routers.keycloak.entrypoints=http,https"
      - "traefik.http.routers.keycloak.tls=true"
      - "traefik.http.services.keycloak.loadbalancer.server.port=8080"
      # Additional router for /realms
      - "traefik.http.routers.keycloak-realms.priority=100"
      - "traefik.http.routers.keycloak-realms.rule=Host(`${OR_HOSTNAME}`) && PathPrefix(`/realms`)"
      - "traefik.http.routers.keycloak-realms.entrypoints=http,https"
      - "traefik.http.routers.keycloak-realms.tls=true"
      - "traefik.http.routers.keycloak-realms.service=keycloak"

  manager:
    restart: always
    image: openremote/manager:${MANAGER_VERSION:-latest}
    depends_on:
      keycloak:
        condition: service_healthy
    environment:
      OR_HOSTNAME: ${OR_HOSTNAME:?Hostname required}
      OR_ADMIN_PASSWORD: ${OR_ADMIN_PASSWORD:?Admin password required}
      OR_SSL_PORT: ${OR_SSL_PORT:--1}
      OR_DEV_MODE: ${OR_DEV_MODE:-false}
      OR_METRICS_ENABLED: ${OR_METRICS_ENABLED:-true}
      OR_SETUP_TYPE:
      OR_SETUP_RUN_ON_RESTART:
      OR_EMAIL_HOST:
      OR_EMAIL_USER:
      OR_EMAIL_PASSWORD:
      OR_EMAIL_X_HEADERS:
      OR_EMAIL_FROM:
      OR_EMAIL_ADMIN:
      OR_ADDITIONAL_HOSTNAMES:
      OR_FORECAST_SOLAR_API_KEY:
      OR_OPEN_WEATHER_API_APP_ID:
      OR_SETUP_IMPORT_DEMO_AGENT_KNX:
      OR_SETUP_IMPORT_DEMO_AGENT_VELBUS:
    volumes:
      - manager-data:/storage
    labels:
      - "traefik.enable=true"
      # Route /manager path to Manager (priority 100 = high)
      - "traefik.http.routers.manager.priority=100"
      - "traefik.http.routers.manager.rule=Host(`${OR_HOSTNAME}`) && PathPrefix(`/manager`)"
      - "traefik.http.routers.manager.entrypoints=http,https"
      - "traefik.http.routers.manager.tls=true"
      - "traefik.http.services.manager.loadbalancer.server.port=8080"
      # Additional router for /api
      - "traefik.http.routers.manager-api.priority=100"
      - "traefik.http.routers.manager-api.rule=Host(`${OR_HOSTNAME}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.manager-api.entrypoints=http,https"
      - "traefik.http.routers.manager-api.tls=true"
      - "traefik.http.routers.manager-api.service=manager"
      # Additional router for /websocket
      - "traefik.http.routers.manager-ws.priority=100"
      - "traefik.http.routers.manager-ws.rule=Host(`${OR_HOSTNAME}`) && PathPrefix(`/websocket`)"
      - "traefik.http.routers.manager-ws.entrypoints=http,https"
      - "traefik.http.routers.manager-ws.tls=true"
      - "traefik.http.routers.manager-ws.service=manager"

  custom-ui:
    build:
      context: .
      dockerfile: deploy/Dockerfile
    restart: always
    depends_on:
      keycloak:
        condition: service_healthy
    environment:
      OR_HOSTNAME: ${OR_HOSTNAME:?Hostname required}
      OR_ADMIN_PASSWORD: ${OR_ADMIN_PASSWORD:?Admin password required}
    labels:
      - "traefik.enable=true"
      # Route root and other paths to Custom UI (lowest priority)
      - "traefik.http.routers.custom-ui.rule=Host(`${OR_HOSTNAME}`)"
      - "traefik.http.routers.custom-ui.entrypoints=http,https"
      - "traefik.http.routers.custom-ui.tls=true"
      - "traefik.http.routers.custom-ui.priority=1"
      - "traefik.http.services.custom-ui.loadbalancer.server.port=5000"
