# OpenRemote v3 - Coolify Production Deployment (Option B: Custom HAProxy)
# Uses Docker Compose configs to embed HAProxy config inline
# Traefik handles SSL termination, HAProxy handles internal routing
# X-Forwarded headers and custom-ui routing

configs:
  haproxy-config:
    content: |
      global
          log stdout format raw local0 notice

      defaults
          log global
          mode http
          timeout connect 30s
          timeout client 60s
          timeout server 60s
          timeout tunnel 720m
          default-server init-addr none

      resolvers docker_resolver
          nameserver dns1 127.0.0.11:53

      frontend http
          bind *:80

          # CRITICAL: Forward original protocol and host info from Traefik
          http-request set-header X-Forwarded-Proto https
          http-request set-header X-Forwarded-Port 443
          http-request set-header X-Forwarded-Host %[req.hdr(host)]
          http-request set-header X-Real-IP %[src]

          # Health endpoint for docker healthcheck
          acl url_docker_health path /docker-health
          http-request set-log-level silent if url_docker_health
          http-request return status 200 if url_docker_health

          # Route auth paths to Keycloak
          acl is_auth path_beg /auth
          use_backend keycloak_backend if is_auth

          # Route realms paths to Keycloak
          acl is_realms path_beg /realms
          use_backend keycloak_backend if is_realms

          # Route resources paths to Keycloak
          acl is_resources path_beg /resources
          use_backend keycloak_backend if is_resources

          # Route custom-ui paths - strip /customui prefix before forwarding
          acl is_customui path_beg /customui
          use_backend customui_backend if is_customui

          # Everything else goes to Manager
          default_backend manager_backend

      backend manager_backend
          server manager manager:8080 resolvers docker_resolver init-addr none

      backend keycloak_backend
          server keycloak keycloak:8080 resolvers docker_resolver init-addr none

      backend customui_backend
          server customui custom-ui:5000 resolvers docker_resolver init-addr none

volumes:
  proxy-data:
  manager-data:
  postgresql-data:


services:
  postgresql:
    restart: always
    image: openremote/postgresql:${POSTGRESQL_VERSION:-latest}
    shm_size: 128mb
    volumes:
      - postgresql-data:/var/lib/postgresql/data
      - manager-data:/storage
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  keycloak:
    restart: always
    image: openremote/keycloak:${KEYCLOAK_VERSION:-latest}
    depends_on:
      postgresql:
        condition: service_healthy
    volumes:
      - ./deploy:/deployment
    environment:
      KEYCLOAK_ADMIN_PASSWORD: ${OR_ADMIN_PASSWORD:?Admin password required}
      KC_HOSTNAME: ${OR_HOSTNAME:?Hostname required}
      KC_HOSTNAME_PORT: ${OR_SSL_PORT:--1}
      # CRITICAL: Trust X-Forwarded headers from Traefik/HAProxy
      KC_PROXY_HEADERS: xforwarded
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_HTTP_ENABLED: "true"

  manager:
    restart: always
    image: openremote/manager:${MANAGER_VERSION:-latest}
    depends_on:
      keycloak:
        condition: service_healthy
    environment:
      OR_HOSTNAME: ${OR_HOSTNAME:?Hostname required}
      OR_ADMIN_PASSWORD: ${OR_ADMIN_PASSWORD:?Admin password required}
      OR_SSL_PORT: ${OR_SSL_PORT:--1}
      OR_DEV_MODE: ${OR_DEV_MODE:-false}
      OR_METRICS_ENABLED: ${OR_METRICS_ENABLED:-true}
      OR_SETUP_TYPE:
      OR_SETUP_RUN_ON_RESTART:
      OR_EMAIL_HOST:
      OR_EMAIL_USER:
      OR_EMAIL_PASSWORD:
      OR_EMAIL_X_HEADERS:
      OR_EMAIL_FROM:
      OR_EMAIL_ADMIN:
      OR_ADDITIONAL_HOSTNAMES:
      OR_FORECAST_SOLAR_API_KEY:
      OR_OPEN_WEATHER_API_APP_ID:
      OR_SETUP_IMPORT_DEMO_AGENT_KNX:
      OR_SETUP_IMPORT_DEMO_AGENT_VELBUS:
    volumes:
      - manager-data:/storage

  proxy:
    image: openremote/proxy:${PROXY_VERSION:-latest}
    restart: always
    depends_on:
      manager:
        condition: service_healthy
    ports:
      - "8883:8883"
    configs:
      - source: haproxy-config
        target: /data/proxy/haproxy.cfg
    volumes:
      - proxy-data:/deployment
    environment:
      HAPROXY_CONFIG: '/data/proxy/haproxy.cfg'
      DOMAINNAME: ${OR_HOSTNAME:?Hostname required}
      DOMAINNAMES: ${OR_ADDITIONAL_HOSTNAMES:-}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.openremote.rule=Host(`${OR_HOSTNAME}`)"
      - "traefik.http.routers.openremote.entrypoints=http,https"
      - "traefik.http.routers.openremote.tls=true"
      - "traefik.http.services.openremote.loadbalancer.server.port=80"

  custom-ui:
    build:
      context: .
      dockerfile: deploy/Dockerfile
    restart: always
    depends_on:
      keycloak:
        condition: service_healthy
    environment:
      OR_HOSTNAME: ${OR_HOSTNAME:?Hostname required}
      OR_ADMIN_PASSWORD: ${OR_ADMIN_PASSWORD:?Admin password required}
      # Subpath prefix for reverse proxy routing
      APP_PREFIX: /customui
