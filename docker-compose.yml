# OpenRemote v3 - Localhost (No Proxy)

volumes:
  manager-data:
  postgresql-data:


services:

  postgresql:
    restart: always
    image: openremote/postgresql:${POSTGRESQL_VERSION:-latest}
    shm_size: 128mb
    volumes:
      - postgresql-data:/var/lib/postgresql/data
      - manager-data:/storage

  keycloak:
    restart: always
    image: openremote/keycloak:${KEYCLOAK_VERSION:-latest}
    depends_on:
      postgresql:
        condition: service_healthy
    ports:
      - "8081:8080" # Expose Keycloak directly for localhost access
    volumes:
      - ./deploy:/deployment
    environment:
      KEYCLOAK_ADMIN_PASSWORD: ${OR_ADMIN_PASSWORD:-secret}
      KC_HOSTNAME: localhost
      KC_HOSTNAME_PORT: -1 # No SSL port

  manager:
    restart: always
    image: openremote/manager:${MANAGER_VERSION:-latest}
    depends_on:
      keycloak:
        condition: service_healthy
    ports:
      - "8080:8080" # Main web interface (HTTP)
      - "8443:8443" # HTTPS (optional, for local HTTPS testing)
      - "1883:1883" # MQTT (non-SSL)
      - "8405:8405" # Metrics

    environment:
      OR_SETUP_TYPE:
      OR_ADMIN_PASSWORD: ${OR_ADMIN_PASSWORD:-secret}
      OR_SETUP_RUN_ON_RESTART:
      OR_EMAIL_HOST:
      OR_EMAIL_USER:
      OR_EMAIL_PASSWORD:
      OR_EMAIL_X_HEADERS:
      OR_EMAIL_FROM:
      OR_EMAIL_ADMIN:
      OR_METRICS_ENABLED: ${OR_METRICS_ENABLED:-true}
      OR_HOSTNAME: localhost
      OR_ADDITIONAL_HOSTNAMES:
      OR_SSL_PORT: -1 # Disable SSL requirement
      OR_DEV_MODE: true # Enable dev mode for HTTP access without proxy

      # configure demo
      OR_FORECAST_SOLAR_API_KEY:
      OR_OPEN_WEATHER_API_APP_ID:
      OR_SETUP_IMPORT_DEMO_AGENT_KNX:
      OR_SETUP_IMPORT_DEMO_AGENT_VELBUS:
    volumes:
      - manager-data:/storage

  custom-ui:
    build:
      context: .
      dockerfile: deploy/Dockerfile
    restart: always
    ports:
      - "5000:5000"
    environment:
      OR_HOSTNAME: localhost
      OR_ADMIN_PASSWORD: ${OR_ADMIN_PASSWORD:-secret}
    depends_on:
      keycloak:
        condition: service_healthy
