# OpenRemote v3
#
# Profile that runs the stack by default on https://localhost using a self-signed SSL certificate,
# but optionally on https://$OR_HOSTNAME with an auto generated SSL certificate from Letsencrypt.
#
# It is configured to use the AWS logging driver.
#
volumes:
  proxy-data:
  manager-data:
  postgresql-data:


services:

  proxy:
    image: openremote/proxy:${PROXY_VERSION:-latest}
    restart: always
    depends_on:
      manager:
        condition: service_healthy
    ports:
      # - "80:80" # LE generation handled by Coolify
      # - "${OR_SSL_PORT:-443}:443"  # Commented out for Coolify - defaults to -1 which is invalid
      # - "443:443"  # Removed for Coolify - it handles SSL termination
      - "8883:8883"
      - "127.0.0.1:8404:8404" # Localhost metrics access
      # - "${PRIVATE_IP:-127.0.0.1}:8404:8404"  # Commented out for Coolify
      # Allows to also expose metrics on a given IP address,
      # intended to be IP of the interface of the private subnet of the EC2 VM
    volumes:
      - proxy-data:/deployment
    environment:
      LE_EMAIL: ${OR_EMAIL_ADMIN:-}
      DOMAINNAME: ${OR_HOSTNAME:-vgscg4skscg88oscgwoc0kwc.185.169.252.53.sslip.io}
      DOMAINNAMES: ${OR_ADDITIONAL_HOSTNAMES:-}
      # USE A CUSTOM PROXY CONFIG - COPY FROM https://raw.githubusercontent.com/openremote/proxy/main/haproxy.cfg
      #HAPROXY_CONFIG: '/data/proxy/haproxy.cfg'

  postgresql:
    restart: always
    # image: openremote/postgresql:${POSTGRESQL_VERSION:-latest}  # 'latest' tag doesn't exist
    image: openremote/postgresql:${POSTGRESQL_VERSION:-15.6.0.4}
    shm_size: 128mb
    volumes:
      - postgresql-data:/var/lib/postgresql/data
      - manager-data:/storage

  keycloak:
    restart: always
    image: openremote/keycloak:${KEYCLOAK_VERSION:-latest}
    depends_on:
      postgresql:
        condition: service_healthy
    volumes:
      - ./deploy:/deployment
    environment:
      KEYCLOAK_ADMIN_PASSWORD: ${OR_ADMIN_PASSWORD:-secret}
      KC_HOSTNAME: ${OR_HOSTNAME:-vgscg4skscg88oscgwoc0kwc.185.169.252.53.sslip.io}
      # KC_HOSTNAME_PORT: ${OR_SSL_PORT:--1}  # Commented out for Coolify - defaults to -1
      KC_HOSTNAME_PORT: 443 # Static port for Coolify compatibility
      KC_HTTP_RELATIVE_PATH: /auth # Restore the context path expected by OpenRemote

  manager:
    #    privileged: true
    restart: always
    image: openremote/manager:${MANAGER_VERSION:-latest}
    depends_on:
      keycloak:
        condition: service_healthy
    ports:
      - "127.0.0.1:8405:8405" # Localhost metrics access
      - "${PRIVATE_IP:-127.0.0.1}:8405:8405"
        # Allows to also expose metrics on a given IP address,
        # intended to be IP of the interface of the private subnet of the EC2 VM
    environment:
      OR_SETUP_TYPE:
      OR_ADMIN_PASSWORD:
      OR_SETUP_RUN_ON_RESTART:
      OR_EMAIL_HOST:
      OR_EMAIL_USER:
      OR_EMAIL_PASSWORD:
      OR_EMAIL_X_HEADERS:
      OR_EMAIL_FROM:
      OR_EMAIL_ADMIN:
      OR_METRICS_ENABLED: ${OR_METRICS_ENABLED:-true}
      OR_HOSTNAME: ${OR_HOSTNAME:-vgscg4skscg88oscgwoc0kwc.185.169.252.53.sslip.io}
      OR_ADDITIONAL_HOSTNAMES: ${OR_ADDITIONAL_HOSTNAMES:-}
      # OR_SSL_PORT: ${OR_SSL_PORT:--1}  # Commented out for Coolify - defaults to -1
      OR_SSL_PORT: 443 # Static port for Coolify compatibility
      OR_DEV_MODE: ${OR_DEV_MODE:-false}

      # The following variables will configure the demo
      OR_FORECAST_SOLAR_API_KEY:
      OR_OPEN_WEATHER_API_APP_ID:
      OR_SETUP_IMPORT_DEMO_AGENT_KNX:
      OR_SETUP_IMPORT_DEMO_AGENT_VELBUS:
    volumes:
      # - ./deployment:/deployment
      - manager-data:/storage

  custom-ui:
    build:
      context: .
      dockerfile: deploy/Dockerfile
    restart: always
    ports:
      - "5000:5000"
    environment:
      OR_HOSTNAME: ${OR_HOSTNAME:-vgscg4skscg88oscgwoc0kwc.185.169.252.53.sslip.io}
      OR_ADMIN_PASSWORD: ${OR_ADMIN_PASSWORD:-secret}
    depends_on:
      keycloak:
        condition: service_healthy
