{% extends "base.html" %}

{% block title %}History Logs{% endblock %}
{% block header %}History Logs{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <!-- Asset/Attribute Selection Bar -->
    <div class="card" style="margin-bottom: 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem; flex: 1; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <label style="font-weight: 600; white-space: nowrap; color: var(--text-muted);">Device:</label>
                    <select id="assetSelect" onchange="loadAttributes(this.value)"
                        style="padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px; min-width: 200px; font-size: 0.95rem;">
                        <option value="">Choose a device...</option>
                    </select>
                </div>
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <label style="font-weight: 600; white-space: nowrap; color: var(--text-muted);">Group:</label>
                    <select id="attributeSelect" disabled
                        style="padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px; min-width: 180px; font-size: 0.95rem;">
                        <option value="">Select a device first...</option>
                    </select>
                </div>
                <div id="subAttributeGroup" style="display: none; align-items: center; gap: 0.75rem;">
                    <label style="font-weight: 600; white-space: nowrap; color: var(--text-muted);">Elements:</label>
                    <select id="subAttributeSelect"
                        style="padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px; min-width: 150px; font-size: 0.95rem;">
                        <option value="">(All)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Time Range Card -->
    <div class="card" style="margin-bottom: 1.5rem;">
        <div
            style="display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 1.5rem;">
            <div style="display: flex; gap: 2rem; flex-wrap: wrap; flex: 1;">
                <!-- Start -->
                <div>
                    <label
                        style="display: block; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem; font-size: 0.85rem;">START
                        DATE / TIME</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="date" id="startDate"
                            style="padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem;">
                        <input type="time" id="startTime"
                            style="padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem; width: 110px;">
                    </div>
                </div>
                <!-- End -->
                <div>
                    <label
                        style="display: block; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem; font-size: 0.85rem;">END
                        DATE / TIME</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="date" id="endDate"
                            style="padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem;">
                        <input type="time" id="endTime"
                            style="padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem; width: 110px;">
                    </div>
                </div>
            </div>
            <!-- Buttons -->
            <div style="display: flex; gap: 0.75rem;">
                <button class="btn-sm" onclick="fetchDatapoints()">Fetch Data</button>
                <button class="btn-sm btn-secondary" onclick="exportDatapoints()">Export CSV</button>
            </div>
        </div>
    </div>

    <!-- Results Section with View Mode -->
    <div class="card">
        <!-- Header with View Options -->
        <div
            style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);">
            <h4 style="margin: 0; color: var(--text-dark);">Data Results</h4>
            <div style="display: flex; align-items: center; gap: 1.5rem;">
                <span style="font-weight: 500; color: var(--text-muted); font-size: 0.85rem;">Show as:</span>
                <label
                    style="cursor: pointer; display: flex; align-items: center; gap: 0.4rem; color: var(--text-dark); font-weight: 500; font-size: 0.9rem;">
                    <input type="radio" name="viewMode" value="table" checked onchange="updateView()"> Table
                </label>
                <label
                    style="cursor: pointer; display: flex; align-items: center; gap: 0.4rem; color: var(--text-dark); font-weight: 500; font-size: 0.9rem;">
                    <input type="radio" name="viewMode" value="graph" onchange="updateView()"> Chart
                </label>
                <label
                    style="cursor: pointer; display: flex; align-items: center; gap: 0.4rem; color: var(--text-muted); font-weight: 500; font-size: 0.9rem;">
                    <input type="radio" name="viewMode" value="json" onchange="updateView()"> Raw Data
                </label>
            </div>
        </div>

        <!-- Initial/Feedback Message -->
        <div id="initialMessage" class="output-box"
            style="text-align: center; color: var(--text-muted); font-family: inherit; font-size: 1rem;">
            Choose a device and group above, then click <strong>Fetch Data</strong> to see the history.
        </div>

        <!-- Raw JSON Data Output -->
        <div id="jsonWrapper" style="display: none; position: relative;">
            <button id="copyBtn" class="copy-btn" onclick="copyToClipboard()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                Copy
            </button>
            <pre id="responseOutput" class="output-box"></pre>
        </div>

        <!-- Table Output -->
        <div id="tableOutput" style="display: none; overflow-x: auto;"></div>

        <!-- Graph Output -->
        <div id="graphOutput" class="graph-container" style="display: none;">
            <canvas id="datapointChart"></canvas>
        </div>
    </div>
</div>

<link rel="stylesheet" href="{{ url_for('static', path='css/history_logs.css') }}">
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    window.USER_REALM = "{{ realm }}";
</script>
<script src="{{ url_for('static', path='js/datapoint_history.js') }}"></script>
{% endblock %}